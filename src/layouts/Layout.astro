
---
interface Props {
    title: string;
    description?: string;
    socialImage?: string;
    structuredData?: Record<string, unknown> | Array<Record<string, unknown>>;
}

const {
    title,
    description = 'AK Web Solutions – Strategische websites, SEO en automatiseringen die je business versnellen.',
    socialImage,
    structuredData,
} = Astro.props;

const siteName = 'AK Web Solutions';
const metaTitle = title.includes(siteName) ? title : `${title} – ${siteName}`;
const canonical = Astro.site ? new URL(Astro.url.pathname, Astro.site).toString() : undefined;
const absoluteSocialImage = socialImage && Astro.site ? new URL(socialImage, Astro.site).toString() : socialImage;
const schemaEntries = Array.isArray(structuredData) ? structuredData : structuredData ? [structuredData] : [];

import '../styles/global.css';
import '../styles/pulse-pages.css';
import '../styles/services-page.css';
import '../styles/blog.css';
import CookieBanner from '../components/common/CookieBanner.astro';
// Public reCAPTCHA site key (can be set via build env PUBLIC_RECAPTCHA_SITE_KEY)
const RECAPTCHA_SITE_KEY = import.meta.env.PUBLIC_RECAPTCHA_SITE_KEY || '6Lfg5fErAAAAAFNB6fEZq1TBrAKH1zysHKXVhCZv';
---

<!doctype html>
<html lang="nl" class="scroll-smooth">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
        <meta name="description" content={description} />
        <meta name="keywords" content="website laten maken Baarn, website maken Utrecht, webdesign Baarn, lokale webdesigner, website voor zzp, website voor mkb, SEO specialist Baarn, online marketing Utrecht, snelle website, WordPress alternatief, website Amersfoort, website Hilversum, webdevelopment Nederland" />
        <meta name="author" content="AK Web Solutions" />
        <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1" />
        <meta name="theme-color" content="#0f0f0f" />
        <meta name="format-detection" content="telephone=yes" />
        <meta name="geo.region" content="NL-UT" />
        <meta name="geo.placename" content="Baarn" />
        <meta name="geo.position" content="52.2117;5.2878" />
        <meta name="ICBM" content="52.2117, 5.2878" />
        {canonical && <link rel="canonical" href={canonical} />}
        
        <!-- Open Graph / Facebook -->
        <meta property="og:type" content="website" />
        <meta property="og:url" content={canonical || Astro.url.href} />
        <meta property="og:title" content={metaTitle} />
        <meta property="og:description" content={description} />
        <meta property="og:image" content={absoluteSocialImage || `${Astro.site}og-image.png`} />
        <meta property="og:locale" content="nl_NL" />
        <meta property="og:site_name" content={siteName} />
        
        <!-- Twitter -->
        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:url" content={canonical || Astro.url.href} />
        <meta name="twitter:title" content={metaTitle} />
        <meta name="twitter:description" content={description} />
        <meta name="twitter:image" content={absoluteSocialImage || `${Astro.site}og-image.png`} />
        
        <!-- Preconnect to external origins -->
        <link rel="preconnect" href="https://img.freepik.com" crossorigin />
        <link rel="preconnect" href="https://cdn.simpleicons.org" crossorigin />
        
        {Astro.url.pathname === '/contact' || Astro.url.pathname === '/contact/' ? (
            <>
                <!-- reCAPTCHA - only on contact page -->
                <link rel="preconnect" href="https://www.google.com" crossorigin />
                <link rel="dns-prefetch" href="https://www.gstatic.com" />
                <script is:inline define:vars={{ RECAPTCHA_SITE_KEY }}>
                    window.RECAPTCHA_SITE_KEY = RECAPTCHA_SITE_KEY;
                    
                    window.loadRecaptcha = function() {
                        if (window.grecaptcha) return Promise.resolve();
                        
                        return new Promise((resolve, reject) => {
                            const script = document.createElement('script');
                            script.src = `https://www.google.com/recaptcha/api.js?render=${RECAPTCHA_SITE_KEY}`;
                            script.async = true;
                            script.defer = true;
                            script.onload = resolve;
                            script.onerror = reject;
                            document.head.appendChild(script);
                        });
                    };
                    
                    if ('requestIdleCallback' in window) {
                        requestIdleCallback(() => window.loadRecaptcha(), { timeout: 5000 });
                    } else {
                        setTimeout(() => window.loadRecaptcha(), 3000);
                    }
                </script>
            </>
        ) : null}
        
        <!-- Google Analytics 4 - Load only on interaction -->
        <script is:inline>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            
            let analyticsLoaded = false;
            
            function initAnalytics() {
                if (analyticsLoaded) return;
                analyticsLoaded = true;
                
                const cookieConsent = localStorage.getItem('cookieConsent');
                if (cookieConsent === 'accepted') {
                    const gaScript = document.createElement('script');
                    gaScript.async = true;
                    gaScript.src = 'https://www.googletagmanager.com/gtag/js?id=G-FN01ZESQ91';
                    document.head.appendChild(gaScript);
                    
                    gaScript.onload = () => {
                        gtag('js', new Date());
                        gtag('config', 'G-FN01ZESQ91', {
                            'anonymize_ip': true,
                            'cookie_flags': 'SameSite=None;Secure'
                        });
                    };
                }
            }
            
            // Load on first interaction (scroll, click, keydown)
            ['scroll', 'click', 'keydown', 'touchstart'].forEach(event => {
                window.addEventListener(event, initAnalytics, { once: true, passive: true });
            });
            
            // Fallback: load after 5s if no interaction
            setTimeout(initAnalytics, 5000);
        </script>
        <meta property="og:title" content={metaTitle} />
        <meta property="og:description" content={description} />
        {canonical && <meta property="og:url" content={canonical} />}
        <meta property="og:type" content="website" />
        <meta property="og:site_name" content={siteName} />
        {absoluteSocialImage && <meta property="og:image" content={absoluteSocialImage} />}
        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:title" content={metaTitle} />
        <meta name="twitter:description" content={description} />
        {absoluteSocialImage && <meta name="twitter:image" content={absoluteSocialImage} />}
        <link rel="icon" type="image/png" href="/favicon.png" />
        
        <!-- Preconnect to critical domains -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link rel="dns-prefetch" href="https://www.google.com" />
        
        <!-- Preload critical fonts with high priority -->
        <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Sora:wght@600;700&display=swap" fetchpriority="high" />
        <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Sora:wght@600;700&display=swap" rel="stylesheet" media="print" onload="this.media='all'" />
        <noscript>
            <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Sora:wght@600;700&display=swap" rel="stylesheet" />
        </noscript>
        
        <!-- Inline critical CSS for instant render -->
        <style>
            body {
                margin: 0;
                background-color: #06070d;
                color: #f4f4f5;
                font-family: system-ui, -apple-system, sans-serif;
            }
            .hero-section { min-height: 100vh; position: relative; }
            .site-brand img { display: block; }
        </style>
        <title>{metaTitle}</title>
        {schemaEntries.map((entry) => (
            <script type="application/ld+json" set:text={JSON.stringify(entry)}></script>
        ))}
    </head>
    <body class="min-h-screen overflow-x-hidden bg-[#0f0f0f] text-white">
        <div data-spotlight class="site-spotlight">
            <slot />
        </div>
    </body>
</html>

<!-- Load heavy animation bundle only on capable devices and during idle/load to keep the layout chunk small -->
<script is:inline type="module">
    (function () {
        try {
            const prefersReducedMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
            const lowThreadDevice = navigator.hardwareConcurrency && navigator.hardwareConcurrency <= 4;

            if (prefersReducedMotion || lowThreadDevice) {
                // Skip loading heavy animations on low-power or reduced-motion devices
                return;
            }

            // CRITICAL: Skip animations.ts on homepage to avoid competing with 3D hero animation
            // Homepage has its own heavy 3D animation (nexusHero.ts ~460KB)
            // Loading both causes main thread blocking and poor PageSpeed scores
            const isHomepage = window.location.pathname === '/' || window.location.pathname === '/index.html';
            
            if (isHomepage) {
                console.log('[layout] Skipping animations.ts on homepage (3D hero takes priority)');
                return;
            }

            const scheduleLoad = () => {
                // dynamic import so bundler doesn't include animations in the layout chunk
                import('../scripts/animations').catch((err) => {
                    // swallow errors — animations are non-critical
                    console.warn('[layout] failed to load animations', err);
                });
            };

            if ('requestIdleCallback' in window) {
                requestIdleCallback(scheduleLoad, { timeout: 2000 });
            } else {
                window.addEventListener('load', () => setTimeout(scheduleLoad, 1200), { once: true });
            }
        } catch (err) {
            // defensive: do nothing if anything goes wrong here
            console.warn('[layout] animation loader error', err);
        }
    })();
</script>

<CookieBanner />
